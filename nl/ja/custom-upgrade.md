---

copyright:
  years: 2017, 2019
lastupdated: "2019-03-07"

subcollection: speech-to-text

---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}
{:tip: .tip}
{:important: .important}
{:note: .note}
{:deprecated: .deprecated}
{:pre: .pre}
{:codeblock: .codeblock}
{:screen: .screen}
{:javascript: .ph data-hd-programlang='javascript'}
{:java: .ph data-hd-programlang='java'}
{:python: .ph data-hd-programlang='python'}
{:swift: .ph data-hd-programlang='swift'}

# カスタム・モデルのアップグレード
{: #customUpgrade}

音声認識の質を高めるために、{{site.data.keyword.speechtotextfull}} サービスは基本モデルを時々更新します。各言語の基本モデルは互いに独立しているため (同一言語の広帯域モデルと狭帯域モデルも同様です)、個別の基本モデルに対する更新は他のモデルに影響を与えません。[リリース・ノート](/docs/services/speech-to-text/release-notes.html)には、基本モデルのすべての更新が記載されています。
{: shortdesc}

新しいバージョンの基本モデルがリリースされた場合は、更新内容を活用するために、その基本モデルをベースにして作成されたすべてのカスタム言語モデルとカスタム音響モデルをアップグレードする必要があります。アップグレードを完了するまでは、ご使用のカスタム・モデルでは古いバージョンの基本モデルが使用され続けます。すべてのカスタマイズ操作と同様に、モデルの所有元であるサービス・インスタンスの資格情報を使用して、そのモデルをアップグレードする必要があります。

できるだけ早く、更新された基本モデルの最新バージョンにアップグレードしてください。カスタム・モデルを早めにアップグレードするほど、その分だけ早く新しいモデルの向上したパフォーマンスを享受できるからです。また、古いバージョンの基本モデルを後でいつでも削除できます。アップグレードを促すために、サービスでは、古い基本モデルをベースにしたカスタム・モデルを使用した認識要求の結果とともに、警告メッセージが返されます。

## アップグレードの仕組み
{: #upgradeOverview}

新しい基本モデルが初めてリリースされた時点では、既存のカスタム・モデルは古いバージョンの基本モデルをベースにしたままです。カスタム・モデルをアップグレードするまでは、そのカスタム・モデルに対するすべての操作は (モデルへのデータ追加やモデルのトレーニングなど)、既存バージョンのモデルに適用されます。同様に、そのカスタム・モデルを指定するすべての認識要求では既存バージョンのモデルが使用されます。

アップグレードを実行すると、同じカスタム・モデルの 2 つのバージョンが得られます。1 つは古いバージョンの基本モデルをベースにしたものであり、もう 1 つは最新バージョンの基本モデルをベースにしたものです。カスタム・モデルをアップグレードした後は、そのカスタム・モデルに対するすべての操作は、アップグレードされた新しいバージョンのモデルに適用されます。古いバージョンのモデルにデータを追加したり、古いバージョンのモデルをトレーニングしたりすることはできなくなります。さらに、アップグレード操作を取り消すことはできません。

どちらかのタイプのカスタム・モデルをアップグレードする場合に、そのモデルの個別リソースをアップグレードする必要はありません。カスタム言語モデルの場合は、そのモデルに対して定義されたすべてのコーパス、文法、および単語が自動的にアップグレードされます。同様に、カスタム音響モデルをアップグレードすると、そのモデルの音声リソースが自動的にアップグレードされます。

デフォルトでは、サービスでは最新バージョンのカスタム・モデルが認識要求で使用されます。ただし、古いバージョンのカスタム・モデルを音声認識用に使用し続けることもできます。詳しくは、[アップグレードされたカスタム・モデルを使用した認識要求の実行](#upgradeRecognition)を参照してください。

## カスタム言語モデルのアップグレード
{: #upgradeLanguage}

以下の手順に従って、カスタム言語モデルをアップグレードします。

1.  カスタム言語モデルが `ready` 状態または `available` 状態であることを確認します。モデルの状態を確認するには、`GET /v1/customizations/{customization_id}` メソッドを使用します。モデルの状態が `ready` の場合は、そのモデルの最新データに基づいてそのモデルをトレーニングする前に、そのモデルをアップグレードしてください。

1.  `POST /v1/customizations/{customization_id}/upgrade_model` メソッドを使用してカスタム言語モデルをアップグレードします。

    ```bash
    curl -X POST -u "apikey:{apikey}"
    "https://stream.watsonplatform.net/speech-to-text/api/v1/customizations/{customization_id}/upgrade_model"
    ```
    {: pre}

    このアップグレード・メソッドは非同期メソッドです。このモデルの単語リソース内の単語数と、サービスに対する現在の負荷によっては、このメソッドが完了するのに数分間かかることがあります。

アップグレード・プロセスが正常に開始されると、サービスは 200 応答コードを返します。 `GET /v1/customizations/{customization_id}` メソッドを使用してモデルのステータスをポーリングすることで、アップグレードのステータスをモニターできます。10 秒間隔でステータスを確認するには、ループを使用します。

アップグレード中は、カスタム・モデルのステータスは `upgrading` となります。アップグレードが完了すると、モデルはアップグレード前のステータスに戻ります (`ready` または `available`)。アップグレード操作のステータス確認は、トレーニング操作のステータス確認とまったく同じです。詳しくは、[モデルのトレーニング要求のモニタリング](/docs/services/speech-to-text/language-create.html#monitorTraining-language)を参照してください。

サービスは、アップグレード要求が完了するまで、対象モデルに変更を加える要求を受け付けることはできません。ただし、アップグレード中に既存バージョンのモデルを使用して引き続き認識要求を発行することはできます。

## カスタム音響モデルのアップグレード
{: #upgradeAcoustic}

以下の手順に従って、カスタム音響モデルをアップグレードします。このカスタム音響モデルがカスタム言語モデルを使用してトレーニングされた場合は、指示されている箇所で 2 つの追加のアップグレード・ステップを実行する必要があります。

1.  *このカスタム音響モデルがカスタム言語モデルを使用してトレーニングされた場合は、*まずそのカスタム言語モデルを最新バージョンの基本モデルにアップグレードする必要があります。詳しくは、[カスタム言語モデルのアップグレード](#upgradeLanguage)を参照してください。

1.  カスタム音響モデルが `ready` 状態または `available` 状態であることを確認します。モデルの状態を確認するには、`GET /v1/acoustic_customizations/{customization_id}` メソッドを使用します。モデルの状態が `ready` の場合は、そのモデルの最新データに基づいてそのモデルをトレーニングする前に、そのモデルをアップグレードしてください。

1.  `POST /v1/acoustic_customizations/{customization_id}/upgrade_model` メソッドを使用してカスタム音響モデルをアップグレードします。

    ```bash
    curl -X POST -u "apikey:{apikey}"
    "https://stream.watsonplatform.net/speech-to-text/api/v1/acoustic_customizations/{customization_id}/upgrade_model"
    ```
    {: pre}

    このアップグレード・メソッドは非同期メソッドです。このモデルに含まれている音声データの量と、サービスに対する現在の負荷によっては、このメソッドが完了するのに数分から数時間かかることがあります。トレーニングの場合と同様に、一般にアップグレードには、対象モデルの音声データの長さの約 2 倍の時間がかかります。

1.  *このカスタム音響モデルがカスタム言語モデルを使用してトレーニングされた場合は、*今回は既にアップグレードされたカスタム言語モデルを使用して、このカスタム音響モデルを再びアップグレードします。`custom_language_model_id` クエリー・パラメーターを使用して、カスタム言語モデルのカスタマイズ ID を指定します。

    ```bash
    curl -X POST -u "apikey:{apikey}"
    "https://stream.watsonplatform.net/speech-to-text/api/v1/acoustic_customizations/{customization_id}/upgrade_model?custom_language_model_id={custom_language_model_id}"
    ```
    {: pre}

    この場合も、このアップグレード・メソッドは非同期メソッドであるため、一般にアップグレードには、対象モデルの音声データの長さの約 2 倍の時間がかかります。

    言語モデルを使用して音響モデルをアップグレードするための要求は、400 応答コードが返されて失敗する場合があり、その場合は `No input data modified since last training` というメッセージが表示されます。このエラーが発生する場合は、ブール型の `force` クエリー・パラメーターを要求に追加して、このパラメーターを `true` に設定します。このパラメーターを使用するのは、このエラー状況でカスタム音響モデルを強制的にアップグレードする場合のみにしてください。
    {: note}

アップグレード・プロセスが正常に開始されると、サービスは 200 応答コードを返します。 `GET /v1/acoustic_customizations/{customization_id}` メソッドを使用してモデルのステータスをポーリングすることで、アップグレードのステータスをモニターできます。1 分間隔でステータスを確認するには、ループを使用します。

アップグレード中は、カスタム・モデルのステータスは `upgrading` となります。アップグレードが完了すると、モデルはアップグレード前のステータスに戻ります (`ready` または `available`)。アップグレード操作のステータス確認は、トレーニング操作のステータス確認とまったく同じです。詳しくは、[モデルのトレーニング要求のモニタリング](/docs/services/speech-to-text/acoustic-create.html#monitorTraining-acoustic)を参照してください。

サービスは、アップグレード要求が完了するまで、対象モデルに変更を加える要求を受け付けることはできません。ただし、アップグレード中に既存バージョンのモデルを使用して引き続き認識要求を発行することはできます。

## アップグレードの失敗
{: #upgradeFailures}

カスタム・モデルに対する別の要求 (トレーニング要求やデータ追加要求など) がサービスによって処理されている場合は、そのカスタム・モデルのアップグレードを開始できません。以下の場合も、アップグレード要求を開始できません。

-   カスタム・モデルの状態が `ready` や `available` 以外の場合。
-   カスタム・モデルにデータ (カスタム単語や音声リソース) が含まれていない場合。
-   カスタム言語モデルを使用してトレーニングされたカスタム音響モデルの場合は、これらのカスタム・モデルは異なるバージョンの基本モデルをベースにしています。カスタム音響モデルをアップグレードする前に、カスタム言語モデルをアップグレードする必要があります。

## カスタム・モデルのバージョン情報の表示
{: #upgradeList}

カスタム・モデルが存在する基本モデルのバージョンを表示するには、次のメソッドを使用します。

-   カスタム言語モデルに関する情報を表示するには、`GET /v1/customizations/{customization_id}` メソッドを使用します。詳しくは、[カスタム言語モデルのリスト](/docs/services/speech-to-text/language-models.html#listModels-language)を参照してください。
-   カスタム音響モデルに関する情報を表示するには、`GET /v1/acoustic_customizations/{customization_id}` メソッドを使用します。詳しくは、[カスタム音響モデルのリスト](/docs/services/speech-to-text/acoustic-models.html#listModels-acoustic)を参照してください。

どちらの場合でも、出力には、カスタム・モデルの基本モデルに関する情報を示す `versions` フィールドが含まれています。次の出力は、アップグレードされたカスタム言語モデルの情報を示しています。

```javascript
{
  "customization_id": "74f4807e-b5ff-4866-824e-6bba1a84fe96",
  "created": "2016-06-01T18:42:25.324Z",
  "language": "en-US",
  "dialect": "en-US",
  "versions": [
    "en-US_BroadbandModel.v07-06082016.06202016",
    "en-US_BroadbandModel.v2017-11-15"
  ],
  "owner": "297cfd08-330a-22ba-93ce-1a73f454dd98",
  "name": "Example model",
  "description": "Example custom language model",
  "base_model_name": "en-US_BroadbandModel",
  "status": "pending",
  "progress": 0
}
```
{: codeblock}

上記の `versions` フィールドは、2 つのバージョンの基本モデルについてカスタム・モデルが存在することを示しています。これらのバージョンは、古いバージョン `en-US_BroadbandModel.v07-06082016.06202016` と、新しいバージョン `en-US_BroadbandModel.v2017-11-15` です。カスタム・モデルがアップグレードされていない場合や、カスタム・モデルの基本モデルが 1 バージョンしか存在しない場合は、`versions` フィールドには 1 つのバージョンが示されます。

## アップグレードされたカスタム・モデルを使用した認識要求の実行
{: #upgradeRecognition}

デフォルトで、サービスでは認識要求で指定された最新バージョンのカスタム・モデルが使用されます。ただし、カスタム・モデルのアップグレード後も、引き続き古いバージョンのモデルを使用して認識要求を発行できます。認識メソッドの `base_model_version` パラメーターを使用して、音声認識用に使用する基本モデルのバージョンを指定します。

例えば、次の HTTP 要求では、古いバージョンの基本モデルを使用することを指定しています。したがって、指定したカスタム言語モデルの古いバージョンも使用されます。

```bash
curl -X POST -u "apikey:{apikey}"
--header "Content-Type: audio/flac"
--data-binary @{path}audio-file.flac
"https://stream.watsonplatform.net/speech-to-text/api/v1/recognize?model=en-US_BroadbandModel&base_model_version=en-US_BroadbandModel.v07-06082016.06202016&language_customization_id={customization_id}"
```
{: pre}

この機能を使用して、カスタム・モデルのパフォーマンスと正確度を、その基本モデルの新旧両バージョンと対比してテストできます。アップグレードされたモデルのパフォーマンスに何らかの問題がある場合は (特定の単語が認識されなくなった場合など)、古いバージョンを認識要求で使用し続けることができます。

[基本モデルのバージョン](/docs/services/speech-to-text/input.html#version)では、`base_model_version` パラメーターを説明しているとともに、認識要求で使用する基本モデルとカスタム・モデルのバージョンがサービスでどのように決定されるのかを説明しています。これらの情報に加えて、カスタム言語モデルとカスタム音響モデルの両方を認識要求を通じて渡す場合に、次の問題を考慮してください。

-   両方のカスタム・モデルは同じ基本モデルをベースにしている必要があります (`en-US_BroadbandModel` など)。
-   両方のカスタム・モデルが古い基本モデルをベースにしている場合、サービスでは古い基本モデルが認識用に使用されます。
-   両方のカスタム・モデルが新しい基本モデルをベースにしている場合、サービスでは新しい基本モデルが認識用に使用されます。
-   2 つのカスタム・モデルのうち 1 つのみが新しい基本モデルにアップグレードされた場合、サービスでは古い基本モデルが認識用に使用されます。サービスで古い基本モデルが選択される理由は、2 つのカスタム・モデルに共通しているのは古いバージョンであるからです。
